# communication schemes

All communication between components is conducted through the interchange of JSON format (via https://) and direct file transfers over SSH. 
Possible communication methods include:
- **Client** (experimentator) **-> Server**: The client sends a `schedule-example.json` to set up experiments. This is initiated by the client through the endpoint POST:/api/users/update_schedule/.
  - The `schedule-example.json` contains sensitive data (name, surname, phone number).
  - The uploading script `upload-schedule.py` calculates `external_id`, inserts it into the JSON file, and removes sensitive data.
- **Server -> Mobile Application** (smartphone): The server sends a `schedule-back-front-example.json` containing the experiment setup for the following few days. This is initiated by the client through the endpoint GET:/api/users/schedules/.
- **Mobile Application -> Server**: The mobile application sends `results-front-back-example.json`, which contains results (answers) and logs (events), as well as `feedback-example.json` (user feedback). These are sent per single experiment after the end of the experiment (may be sent at the beginning of a new experiment if the connection is unavailable). This is initiated by the client through the endpoints POST:/api/feedback-comments/feedback-comments_create/ and POST:/api/watch-results/watch-results_create/.
- **Server -> Customer**: The server sends `results-example.json`, which contains the results of the experiment(s), and `feedback-example.json` (user feedback). These are all initiated by the customer through the endpoints GET:/api/watch-results/watch-results_list/ and GET:/api/feedback-comments/feedback-comments_list/.

Communication using the REST API is secured with the SSL protocol and authorization is achieved through the use of tokens in the HTTP header. These tokens are generated by user hash functions, as described in the main [README.md](../README.md) file. Tokens are generated on the tester's device during the application registration process and on the experimenter's device while preparing the experiment.

# [schedule-example.json](./json-templates/schedule-example.json)
This is an exemplary JSON file for configuring an experiment per user. The preferred naming convention is: schedule-NAME_SURNAME_PHONENUMBER.json. Additional information includes:
- The experiment is configured for the next few days (not the entire period); in case of collisions, [overwriting rules](./README_overwriting_rules.md) (processed on the server side) are applied.
- Bulk upload is supported by the Python script [upload-schedule.py](../client_scripts/scripts/upload-schedule.py).
- If the user (external_id) does not exist, create it and populate it with data (schedule).
- **Anonymize** data by removing name, surname, and phone number.
- `service_name` can be {"", "A", "B", "C", "D", "E", "F", ...}.
- `reply_form` describes the query form:
  - It is an obligatory key, but it may be empty (no query).
  - There are 3 types: MOS, free text, and external query on Qualtrics.
  - The Qualtrics query must be the last one, with a single link but possibly containing multiple queries; there is no return from Qualtrics to the app.
  - The order of elements/questions in `reply_form` is meaningful and [preserved](https://www.rfc-editor.org/rfc/rfc7159.html) during processing.
  - Only one question per page.
  - `optional_id` is optional, it may be descriptive and consist of any text.
  - `type` can be "MOS" (internal), "TEXT" (internal), or "QUALTRICS" (external).
  - `description` contains the visible description of a question; 'eng' is the fallback language.

Reply form:
- The MOS type includes a value and description for each button. It can be a 1-5 scale, true/false, or any format described in the JSON file.
- The TEXT type is self-explanatory.
- The QUALTRICS type is external and not rendered in the app.

# [schedule-back-front-example.json](./json-templates/schedule-back-front-example.json)
The client requests information about the experiment setup for the next few days (e.g., 3 days). This JSON file is similar to `schedule-example.json`, with additional information such as schedule/service/**reply_url**. Additional information includes:
- The client uses REST API to request data about the "user" for a given date range.
- The JSON file does not contain sensitive data, only the "external_id".

# [results-front-back-example.json](./json-templates/results-front-back-example.json)
This JSON file contains the results sent by the client to the server.
- `reply_form` should be a copy from [schedule-back-front-example.json](./json-templates/schedule-back-front-example.json) with added responses:
  - Responses are obligatory, but they can be empty.
  - `answer`/`timestamp`: user response/accepted (in QUALTRICS, the moment when the user selects the link to Qualtrics).
  - User response time can be calculated by subtracting the previous `timestamp` (or `query_started` if it is the first) from the current `timestamp`.
  - `content`: "MOS" - string {"1", "2", "3", "4", "5"}, "TEXT" - free text in UTF-8 entered by the user, "QUALTRICS" - True if visited, False if not visited (only for uniform data types).
- `query_started`: ISO datetime of when the query started (visible screen) - a single key at the level of `reply_form`, indicating the beginning of the entire query block (a few questions).
  - It is obligatory and should be equal to `playback_ended` if there are no queries.

# [results-example.json](./json-templates/results-example.json)
This JSON file contains the results generated from experiments and is returned by the `POST:/api/watch-results/watch-results_list` endpoint.
- The file includes a list with `results-from-back-example.json`.
- Additionally, a list of `user_feedback` is added to each entry.

NOTE: `user_feedback` is incomplete (2023-06-19), issue [backend #82], endpoint returns first feedback. Now postprocessing is done by download-results.py script, single feedback is removed and list of feedback is added.   

Possible query configurations for retrieving results:
- For a single user (entire existing log)
- For a single user within a given date range
- For all users (entire existing log)
- For all users within a given date range 
- The results do not contain any sensitive data. The "external_id" is used instead of the name, surname, and phone number.

# [feedback-example.json](./json-templates/feedback-example.json)
This JSON file contains the results generated from experiments and is returned by the `GET:/api/feedback-comments/feedback-comments_list/` endpoint. It comprises a list of user feedbacks (comments).

The action is initiated by the customer (via a Python script). The preferred naming convention is: results-feedback-{external_id}.json.
